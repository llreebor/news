<!-- [START] HTML Input -->
<div class="mt-10">
	<!-- Single -->
	<div class="mb-6">
		<label class="mb-4 block text-sm font-medium text-gray-700">
			Value:
			<span id="singleValueDisplay" class="font-bold text-blue-600">50</span>
		</label>
		<div class="relative">
			<div
				id="singleTrack"
				class="relative h-2 w-full cursor-pointer rounded-full bg-gray-200"
			>
				<div
					id="singleFill"
					class="slider-fill absolute top-0 left-0 h-full rounded-full bg-gradient-to-r from-blue-500 to-purple-600"
					style="width: 50%"
				></div>
				<div
					id="singleThumb"
					class="slider-thumb absolute top-1/2 h-6 w-6 -translate-x-1/2 -translate-y-1/2 transform cursor-grab rounded-full border-4 border-blue-500 bg-white shadow-lg"
					style="left: 50%"
				></div>
			</div>
			<div class="mt-2 flex justify-between text-xs text-gray-500">
				<span>0</span>
				<span>100</span>
			</div>
		</div>
		<input type="hidden" id="singleHidden" value="50" />
	</div>

	<!-- Multiple -->
	<div class="mb-6">
		<label class="mb-4 block text-sm font-medium text-gray-700">
			Range:
			<span id="rangeValueDisplay" class="font-bold text-green-600">
				20 - 60
			</span>
		</label>
		<div class="relative">
			<div
				id="rangeTrack"
				class="relative h-2 w-full cursor-pointer rounded-full bg-gray-200"
			>
				<div
					id="rangeFill"
					class="slider-fill absolute top-0 left-0 h-full rounded-full bg-gradient-to-r from-green-400 to-green-600"
					style="left: 20%; width: 40%"
				></div>
				<div
					id="rangeThumbMin"
					class="slider-thumb absolute top-1/2 h-6 w-6 -translate-x-1/2 -translate-y-1/2 transform cursor-grab rounded-full border-4 border-green-500 bg-white shadow-lg"
					style="left: 20%"
				></div>
				<div
					id="rangeThumbMax"
					class="slider-thumb absolute top-1/2 h-6 w-6 -translate-x-1/2 -translate-y-1/2 transform cursor-grab rounded-full border-4 border-green-500 bg-white shadow-lg"
					style="left: 60%"
				></div>
			</div>
			<div class="mt-2 flex justify-between text-xs text-gray-500">
				<span>0</span>
				<span>100</span>
			</div>
		</div>
		<input type="hidden" id="rangeHiddenMin" value="20" />
		<input type="hidden" id="rangeHiddenMax" value="60" />
	</div>
</div>
<!-- [END] HTML Input -->

<!-- [START] JavaScript Input -->
<script>
	// Class

	class CustomRangeInput {
		constructor(opts = {}) {
			// core settings
			this.track = document.getElementById(opts.trackId)
			if (!this.track) {
				console.warn("CustomRangeInput: track not found", opts.trackId)
				return
			}

			this.isRange = !!opts.isRange
			this.min = Number(opts.min ?? 0)
			this.max = Number(opts.max ?? 100)

			// state
			this.isDragging = false
			this.activePointerId = null
			this.activePointerElem = null
			this.draggingThumb = null
			this._animFrame = null

			// elements
			this.fill = document.getElementById(opts.fillId)
			this.display = document.getElementById(opts.displayId)

			if (!this.isRange) {
				this.thumb = document.getElementById(opts.thumbId)
				this.hidden = document.getElementById(opts.hiddenInputId)
				this.value = Number(opts.initial ?? this.min)

				if (!this.thumb) {
					console.warn("CustomRangeInput: single thumb not found", opts.thumbId)
					return
				}
			} else {
				this.thumbMin = document.getElementById(opts.thumbMinId)
				this.thumbMax = document.getElementById(opts.thumbMaxId)
				this.hiddenMin = document.getElementById(opts.hiddenMinId)
				this.hiddenMax = document.getElementById(opts.hiddenMaxId)
				this.valueMin = Number(opts.initialMin ?? this.min)
				this.valueMax = Number(opts.initialMax ?? this.max)

				if (!this.thumbMin || !this.thumbMax) {
					console.warn(
						"CustomRangeInput: range thumbs not found",
						opts.thumbMinId,
						opts.thumbMaxId,
					)
					return
				}
			}

			// bind methods
			this._onPointerDownTrack = this._onPointerDownTrack.bind(this)
			this._onPointerDownThumb = this._onPointerDownThumb.bind(this)
			this._onPointerMove = this._onPointerMove.bind(this)
			this._onPointerUp = this._onPointerUp.bind(this)
			this._onPointerCancel = this._onPointerCancel.bind(this)
			this._onBlur = this._onBlur.bind(this)

			this._attachEvents()
			this._updateUI()
		}

		// ---------- Events ----------
		_attachEvents() {
			this.track.addEventListener("pointerdown", this._onPointerDownTrack)

			if (!this.isRange) {
				this.thumb.addEventListener("pointerdown", (e) =>
					this._onPointerDownThumb(e, "single"),
				)
			} else {
				this.thumbMin.addEventListener("pointerdown", (e) =>
					this._onPointerDownThumb(e, "min"),
				)
				this.thumbMax.addEventListener("pointerdown", (e) =>
					this._onPointerDownThumb(e, "max"),
				)
			}

			document.addEventListener("pointermove", this._onPointerMove)
			document.addEventListener("pointerup", this._onPointerUp)
			document.addEventListener("pointercancel", this._onPointerCancel)

			document.addEventListener("mouseleave", this._onPointerUp)
			window.addEventListener("blur", this._onBlur)
		}

		_onPointerDownTrack(e) {
			// if click happens on thumb, skip
			if (
				e.target === this.thumb ||
				e.target === this.thumbMin ||
				e.target === this.thumbMax
			)
				return

			const clientX = e.clientX
			if (!this.isRange) {
				const target = this._valueFromClientX(clientX)
				this._startSmoothTo(target, "single")
			} else {
				const clickedVal = this._valueFromClientX(clientX)
				const distToMin = Math.abs(clickedVal - this.valueMin)
				const distToMax = Math.abs(clickedVal - this.valueMax)
				const targetThumb = distToMin <= distToMax ? "min" : "max"
				this._startSmoothTo(clickedVal, targetThumb)
			}
		}

		async _onPointerDownThumb(e, thumbType) {
			e.preventDefault()
			e.stopPropagation()

			if (this.activePointerId !== null && this.activePointerId !== e.pointerId)
				return

			const elem =
				thumbType === "single"
					? this.thumb
					: thumbType === "min"
						? this.thumbMin
						: this.thumbMax

			try {
				elem.setPointerCapture(e.pointerId)
				this.activePointerElem = elem
			} catch (err) {}

			this.activePointerId = e.pointerId
			this.isDragging = true
			this.draggingThumb = thumbType

			elem.classList.add("scale-110", "cursor-grabbing", "shadow-xl")
			elem.classList.remove("cursor-grab")
		}

		_onPointerMove(e) {
			if (!this.isDragging) return
			if (this.activePointerId !== null && e.pointerId !== this.activePointerId)
				return

			const clientX = e.clientX
			if (!this.isRange) {
				this._cancelSmooth()
				this.value = this._valueFromClientX(clientX)
				this._updateUI()
				return
			}

			this._cancelSmooth()
			if (this.draggingThumb === "min") {
				const v = this._valueFromClientX(clientX)
				this.valueMin = Math.min(v, this.valueMax - 1)
			} else if (this.draggingThumb === "max") {
				const v = this._valueFromClientX(clientX)
				this.valueMax = Math.max(v, this.valueMin + 1)
			}
			this._updateUI()
		}

		_onPointerUp(e) {
			if (
				this.activePointerId !== null &&
				e &&
				e.pointerId !== this.activePointerId
			) {
				return
			}

			if (this.activePointerElem && this.activePointerId !== null) {
				try {
					this.activePointerElem.releasePointerCapture(this.activePointerId)
				} catch (err) {}
			}

			if (!this.isRange && this.thumb) {
				this.thumb.classList.remove("scale-110", "cursor-grabbing", "shadow-xl")
				this.thumb.classList.add("cursor-grab")
			} else if (this.isRange) {
				if (this.thumbMin) {
					this.thumbMin.classList.remove(
						"scale-110",
						"cursor-grabbing",
						"shadow-xl",
					)
					this.thumbMin.classList.add("cursor-grab")
				}
				if (this.thumbMax) {
					this.thumbMax.classList.remove(
						"scale-110",
						"cursor-grabbing",
						"shadow-xl",
					)
					this.thumbMax.classList.add("cursor-grab")
				}
			}

			this.isDragging = false
			this.activePointerId = null
			this.activePointerElem = null
			this.draggingThumb = null
		}

		_onPointerCancel() {
			this._onPointerUp()
		}

		_onBlur() {
			this._onPointerUp()
		}

		// ---------- Helpers ----------
		_valueFromClientX(clientX) {
			const rect = this.track.getBoundingClientRect()
			let percent = (clientX - rect.left) / rect.width
			percent = Math.max(0, Math.min(1, percent))
			const val = Math.round(this.min + percent * (this.max - this.min))
			return val
		}

		_percentFromValue(val) {
			return ((val - this.min) / (this.max - this.min)) * 100
		}

		_updateUI() {
			if (!this.isRange) {
				const p = this._percentFromValue(this.value)
				if (this.fill) this.fill.style.width = p + "%"
				if (this.thumb) this.thumb.style.left = p + "%"
				if (this.display) this.display.textContent = String(this.value)
				if (this.hidden) this.hidden.value = String(this.value)
			} else {
				if (this.valueMin > this.valueMax) {
					;[this.valueMin, this.valueMax] = [this.valueMax, this.valueMin]
				}
				const pMin = this._percentFromValue(this.valueMin)
				const pMax = this._percentFromValue(this.valueMax)
				if (this.fill) {
					this.fill.style.left = pMin + "%"
					this.fill.style.width = pMax - pMin + "%"
				}
				if (this.thumbMin) this.thumbMin.style.left = pMin + "%"
				if (this.thumbMax) this.thumbMax.style.left = pMax + "%"
				if (this.display)
					this.display.textContent = `${this.valueMin} - ${this.valueMax}`
				if (this.hiddenMin) this.hiddenMin.value = String(this.valueMin)
				if (this.hiddenMax) this.hiddenMax.value = String(this.valueMax)
			}
		}

		// ---------- Smooth animation ----------
		_startSmoothTo(targetValue, thumbType = "single") {
			this._cancelSmooth()
			if (this.isDragging) return

			if (!this.isRange) {
				this._smoothAnimate(() => {
					const diff = targetValue - this.value
					if (Math.abs(diff) < 0.5) {
						this.value = targetValue
						this._updateUI()
						return true
					}
					this.value += diff * 0.2
					this.value = Math.round(this.value)
					this._updateUI()
					return false
				})
			} else {
				if (thumbType === "min") {
					this._smoothAnimate(() => {
						const diff = targetValue - this.valueMin
						if (Math.abs(diff) < 0.5) {
							this.valueMin = Math.min(targetValue, this.valueMax - 1)
							this._updateUI()
							return true
						}
						this.valueMin += diff * 0.2
						this.valueMin = Math.round(
							Math.min(this.valueMin, this.valueMax - 1),
						)
						this._updateUI()
						return false
					})
				} else if (thumbType === "max") {
					this._smoothAnimate(() => {
						const diff = targetValue - this.valueMax
						if (Math.abs(diff) < 0.5) {
							this.valueMax = Math.max(targetValue, this.valueMin + 1)
							this._updateUI()
							return true
						}
						this.valueMax += diff * 0.2
						this.valueMax = Math.round(
							Math.max(this.valueMax, this.valueMin + 1),
						)
						this._updateUI()
						return false
					})
				}
			}
		}

		_smoothAnimate(stepFn) {
			const frame = () => {
				try {
					const done = stepFn()
					if (!done) {
						this._animFrame = requestAnimationFrame(frame)
					} else {
						this._animFrame = null
					}
				} catch (err) {
					this._animFrame = null
				}
			}
			this._animFrame = requestAnimationFrame(frame)
		}

		_cancelSmooth() {
			if (this._animFrame) {
				cancelAnimationFrame(this._animFrame)
				this._animFrame = null
			}
		}

		// ---------- API ----------
		setValue(v) {
			if (!this.isRange) {
				this.value = Math.max(this.min, Math.min(this.max, Number(v)))
			} else {
				if (!Array.isArray(v) || v.length < 2) return
				this.valueMin = Math.max(this.min, Math.min(this.max, Number(v[0])))
				this.valueMax = Math.max(this.min, Math.min(this.max, Number(v[1])))
				if (this.valueMin > this.valueMax)
					[this.valueMin, this.valueMax] = [this.valueMax, this.valueMin]
			}
			this._updateUI()
		}

		getValue() {
			return this.isRange ? [this.valueMin, this.valueMax] : this.value
		}
	}

	document.addEventListener("DOMContentLoaded", () => {
		// single
		new CustomRangeInput({
			trackId: "singleTrack",
			thumbId: "singleThumb",
			fillId: "singleFill",
			displayId: "singleValueDisplay",
			hiddenInputId: "singleHidden",
			min: 0,
			max: 100,
			initial: 50,
		})

		// range
		new CustomRangeInput({
			isRange: true,
			trackId: "rangeTrack",
			thumbMinId: "rangeThumbMin",
			thumbMaxId: "rangeThumbMax",
			fillId: "rangeFill",
			displayId: "rangeValueDisplay",
			hiddenMinId: "rangeHiddenMin",
			hiddenMaxId: "rangeHiddenMax",
			min: 0,
			max: 100,
			initialMin: 20,
			initialMax: 60,
		})
	})
</script>
<!-- [END] JavaScript Input -->
